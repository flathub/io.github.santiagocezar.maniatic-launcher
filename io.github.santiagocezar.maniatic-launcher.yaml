
app-id: io.github.santiagocezar.maniatic-launcher
runtime: org.gnome.Platform
runtime-version: "45"
sdk: org.gnome.Sdk
command: maniatic
finish-args:
  - --share=ipc
  # works when using SDL2
  - --socket=wayland
  - --socket=fallback-x11
  - --env=SDL_VIDEODRIVER=wayland,x11
  - --socket=pulseaudio
  - --persist=.
  # gamepads
  - --device=all
  # to copy the Data.rsdk from user installed Sonic Mania
  # - --filesystem=xdg-data/Steam:ro
  # disabled temporally until the exception is accepted
  - --filesystem=~/.steam:ro
  - --filesystem=~/.var/app/com.valvesoftware.Steam:ro
modules:
  - name: mania
    no-autogen: true
    no-make-install: true
    buildsystem: cmake-ninja
    builddir: true
    build-options:
      cxxflags: '-Wp,-U_FORTIFY_SOURCE'
    config-opts:
      - -DRETRO_DISABLE_PLUS=ON
      - -DRETRO_SUBSYSTEM=SDL2
    post-install:
      - install -Dp -m 755 "$FLATPAK_BUILDER_BUILDDIR/_flatpak_build/dependencies/RSDKv5/libGame.so" /app/lib/Game.so
      - install -Dp -m 755 "$FLATPAK_BUILDER_BUILDDIR/_flatpak_build/dependencies/RSDKv5/RSDKv5U" /app/bin/RSDKv5U
      - install -Dp -m 644 "$FLATPAK_BUILDER_BUILDDIR/dependencies/RSDKv5/RSDKv5/Shaders/OGL/"* -t /app/share/OpenGL-Shaders/Data/Shaders/OGL
      - install -Dp -m 644 "$FLATPAK_BUILDER_BUILDDIR/ogl-shader-mod.ini" /app/share/OpenGL-Shaders/mod.ini
    sources:
      - type: git
        url: https://github.com/Rubberduckycooly/Sonic-Mania-Decompilation.git
        commit: c417ccad32945075a283f74429a3a09cd501734d
        disable-submodules: true
      - type: git
        url: https://github.com/Rubberduckycooly/RSDKv5-Decompilation.git
        commit: 64df5c1b3cb0583e2f88a4b8a909294e4e15cbdb
        dest: dependencies/RSDKv5
      - type: file
        path: ogl-shader-mod.ini
  - name: blueprint-compiler
    builddir: true
    buildsystem: meson
    sources:
      - type: git
        url: https://gitlab.gnome.org/jwestman/blueprint-compiler.git
        tag: v0.2.0
    cleanup: ['*']
  - name: launcher
    buildsystem: meson
    sources:
      - type: git
        url: https://github.com/santiagocezar/maniatic-launcher.git
        commit: 06bdf2233df4ddf1690e078b826d775fb7b82294
    cleanup:
      - /share/blueprint-compiler
